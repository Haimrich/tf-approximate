all: axqconv.so tables tune

.PHONY=clean


.tfconfig:
	python3 -c 'import tensorflow as tf; print("TF_CFLAGS=" + " ".join(tf.sysconfig.get_compile_flags())); print("TF_LFLAGS=" + " ".join(tf.sysconfig.get_link_flags()))' > $@

include .tfconfig

axmult.cc: $(wildcard axmult/*.c)
	(echo "//automatically generated by makefile" ; cat $^) > $@

axmult.o: axmult.cc
	g++ -std=c++11 $^ -c -o $@

axmult.h: axmult.cc
	python generate_header.py $^ > $@

axqconv.so: axqconv.cc axmult.cc axmult.h approximate_selector.h
	g++ -std=c++11 -Wno-ignored-attributes -shared $(filter-out %.h, $^) -o $@ -fPIC ${TF_CFLAGS} ${TF_LFLAGS} -O2

tune: tune.o axmult.o
	g++ -o $@ $^

tables: tables.cc axmult.o approximate_selector.h
	g++ -o $@ $(filter-out %.h, $^) 

clean:
	rm axmult.o tables tune axqconv.so axmult.h axmult.cc tune.o .tfconfig
